# Android应用窗口
#### 目录介绍
- 01.Android组件UI实现
    - 1.1 组件的UI实现介绍
    - 1.2 Activity组件类关系
    - 1.3 Window类的实现
    - 1.4 ViewRoot类的实现
- 02.上下文环境创建过程
    - 2.1 窗口运行环境介绍
    - 2.2 Context创建流程



### 01.Android组件UI实现
#### 1.1 组件的UI实现介绍
- Activity组件的UI实现需要与WindowManagerService服务和SurfaceFlinger服务进行交互。
    - Activity组件在启动完成后，会通过一个类型为Session的Binder对象来请求WindowManagerService为它创建一个类型为WindowState的对象，用来描述它的窗口状态。
    - Android应用程序会通过一个类型为Client的Binder对象来请求SurfaceFlinger服务为它创建一个类型为Layer的对象，用来描述它的窗口数据。
- Activity组件与WindowManagerService服务和SurfaceFlinger服务的交互模型
    - ![image](https://img-blog.csdnimg.cn/15f1dd26c6604b2086fbc5709e8ad913.png)



#### 1.2 Activity组件类关系
- Activity组件的类关系图
    - ![image](https://img-blog.csdnimg.cn/6d7a25acd0d44157b2d177fb3616ec53.png)
- Activity类与Context关系
    - Activity类是从ContextThemeWrapper类继承下来的，而ContextThemeWrapper类又是从ContextWrapper类继承下来的，最后ContextWrapper类又继承了Context类。
    - 这个ContextImpl对象首先是通过调用Activity类的成员函数attach传递到Activity组件内部，接着再依次通过调用父类ContextThemeWrapper和ContextWrapper的成员函数attachBaseContext来分别保存在它们的成员变量mBase中。
    - 因此，ContextThemeWrapper和ContextWrapper类的成员变量mBase指向的实际上是一个ContextImpl对象。
- Activity启动是如何和Context交互的
    > ActivityThread#performLaunchActivity()，创建Activity类型上下文Context然后创建activity对象
    > ActivityThread#createBaseContextForActivity()，通过ContextImpl静态方法创建该对象
    > ContextImpl#createActivityContext()，通过new去新建一个ContextImpl对象，并且做初始化配置操作


#### 1.3 Window类的实现
- Activity组件创建一个PhoneWindow
    - ![image](https://img-blog.csdnimg.cn/6aedf6d232f04dee8012e8ff07ee8194.png)
- PhoneWindow创建过程
    > ActivityThread#performLaunchActivity()，通过反射的机制创建的Activity，并调用了Activity的attach方法
    > Activity#attach()，在attach方法这里初始化了一些Activity的成员变量，最重要是创建PhoneWindow对象
- PhoneWindow类的实现说明
    - PhoneWindow类有两个重要的成员变量mDecor和mContentParent，它们的类型分别DecorView和ViewGroup。
    - 其中，成员变量mDecor是用描述自己的窗口视图，而成员变量mContentParent用来描述视图内容的父窗口。
- DecorView类继承了FrameLayout类
    - DecorView类继承了FrameLayout类，而FrameLayout类又继承了ViewGroup类，最后ViewGroup类又继承了View类。View类有一个成员函数draw，它是用来绘制应用程序窗口的UI的。
    - DecorView类、FrameLayout类和ViewGroup类都重写了父类的成员函数draw，这样，它们就都可以定制自己的UI。
- DecorView类所描述的应用程序窗口视图是否需要重新绘制是由另外一个类ViewRoot来控制的。
    - 系统在启动一个Activity组件的过程中，会为这个Activity组件创建一个ViewRoot对象，同时还会将前面为这个Activity组件所创建的一个PhoneWindow对象的成员变量mDecor所描述的一个视图（DecorView）保存在这个ViewRoot对象的成员变量mView中。
    - 这个ViewRoot对象就可以通过调用它的成员变量mView的所描述的一个DecorView的成员函数draw来绘制一个Activity组件的UI了。



#### 1.4 ViewRoot类的实现
- ViewRoot类的实现图
    - ![image](https://img-blog.csdnimg.cn/08db5172602841529d8c5873660e324f.png)
    - ViewRoot类的作用是非常大的，它除了用来控制一个Activity组件的UI绘制之外，还负责接收Activity组件的IO输入事件，例如，键盘事件
- ViewRoot类的创建过程
    > WindowManagerImpl#addView()，在这个类中可以看到调用了mGlobal.addView()，而mGlobal是WindowManagerGlobal的对象。
    > WindowManagerGlobal#addView()，这里面逻辑很核心，创建ViewRootImpl对象，这个是布局渲染的核心类
    > WindowManagerGlobal#addView#root.setView()，实现了view与root的关联，这个root是ViewRootImpl对象



### 02.上下文环境创建过程
#### 2.1 窗口运行环境介绍
- Android应用程序窗口在运行的过程中，需要访问一些特定的资源或者类。
    - 这些特定的资源或者类构成了Android应用程序的运行上下文环境，Android应用程序窗口可以通过一个Context接口来访问它，这个Context接口也是我们在开发应用程序时经常碰到的。
- Android应用程序窗口的运行上下文环境是通过ContextImpl类来描述的，即每一个Activity组件都关联有一个ContextImpl对象。
    - ![image](https://img-blog.csdnimg.cn/f01624ded7b14201b870217fb5624d5e.png)
    - Activity组件通过其父类ContextThemeWrapper和ContextWrapper的成员变量mBase来引用了一个ContextImpl对象。
    - 这样，Activity组件以后就可以通过这个ContextImpl对象来执行一些具体的操作，例如，启动Service组件、注册广播接收者和启动Content Provider组件等操作。



#### 2.2 Context创建流程
- Context创建流程
    - 通过ActivityThread类的成员函数performLaunchActivity在应用程序进程中创建一个Activity实例，并且为它设置运行上下文环境，即为它创建一个ContextImpl对象。
    - ![image](https://img-blog.csdnimg.cn/31f9b74ee10644a4ac6ce2952d567c93.png)
- Android应用程序窗口的运行上下文环境的创建过程
    - 第一步：ActivityThread#performLaunchActivity()，主要看mInstrumentation.newActivity()的过程。Instrumentation类是用来记录应用程序与系统的交互过程的
        - 要启动的Activity组件的类名保存在变量component。有了这个类名之后，函数就可以调用ActivityThread类的成员变量mInstrumentation所描述一个Instrumentation对象的成员函数newActivity来创建一个Activity组件实例了，并且保存变量activity中。
    - 第二步：ActivityThread#createBaseContextForActivity，这里是创建ContextImpl的步骤
        - 
    - 第三步：Instrumentation#newActivity()，这个是创建activity的过程。创建好了要启动的Activity组件实例之后，函数接下来就可以对它进行初始化了。
    - 第四步：new Activity，第二步通过反射创建activity对象，创建对象是必须通过构造函数创建的
        - 一般来说，一个类的构造函数是用来初始化该类的实例的，系统为Activity类提供的默认构造函数什么也不做，也就是说，Activity类实例在创建的时候，还没有执行实质的初始化工作。
    - 第五步：appContext.setOuterContext()，
    - 第六步：activity.attach()，
        - 初始化一个Activity组件实例需要一个Application对象app、一个ContextImpl对象appContext以及一个Configuration对象config，它们分别用来描述该Activity组件实例的应用程序信息、运行上下文环境以及配置信息。
        - 
    - 第七步：ContextThemeWrapper.attachBaseContext()，接着第五步往下分析
    - 第八步：ContextWrapper.attachBaseContext()，，接着第七步往下分析
    - 第九步：Instrumentation#callActivityOnCreate()，主要是执行activity的生命周期onCreate
        - 函数主要就是调用当前正在启动的Activity组件的成员函数onCreate，用来通知它已经成功地创建和启动完成了。
    - 第十步：Activity#onCreate()，











