#### 目录介绍
- 01.整体概述介绍
    - 1.1 项目背景
    - 1.2 思考问题
    - 1.3 设计目标
    - 1.4 收益分析
- 02.抓包的原理分析
    - 2.0 Https三要素
    - 2.1 抓包核心原理
    - 2.2 如何搞定CA证书
    - 2.3 抓包原理图
    - 2.4 抓包核心流程
- 03.防止抓包思路
    - 3.1 先看如何抓包
    - 3.2 设置配置文件
    - 3.3 关闭代理
    - 3.4 数据加密处理
    - 3.5 黑科技抓包
- 04.防抓包实践开发
    - 4.1 App安全配置
    - 4.2 关闭代理
    - 4.3 证书校验
    - 4.3 OkHttp配置
    - 4.4 防止挂载抓包
- 05.其他设计说明
    - 5.1 性能设计
    - 5.2 测试用例设计
    - 5.3 稳定性设计
    - 5.4 灰度设计
    - 5.5 降级设计
    - 5.6 异常设计



### 01.整体概述介绍
#### 1.1 项目背景
- 通讯安全是App安全检测过程中非常重要的一项
    - 针对该项的主要检测手段就是使用中间人代理机制对网络传输数据进行抓包、拦截和篡改，以检验App在核心链路上是否有安全漏洞。
- 保证数据安全
    - 通过charles等工具可以对app的网络请求进行抓包，这样这些信息就会被清除的提取出来，会被不法分子进行利用。
- 不想被竞争对手逆向抓包
    - 不想自身App的数据被别人轻而易举地抓包获取到，从而进行类似业务或数据分析、爬虫或网络攻击等破坏性行为。
    - 这样就要求我们必须对数据传输做好安全保护措施和完整性校验，以防止自身数据在网络传输中裸奔，甚至是被三方恶意利用或攻击。


#### 1.2 思考问题
- 开发项目的时候，都需要抓包，很多情况下即使是Https也能正常抓包正常。那么问题来了：
    - 抓包的原理是？
    - 任何Https的 app 都能抓的到吗？
    - 如果不能，哪些情况下可以抓取，哪些情况下抓取不到？
- Android 7.0及以上为何不能轻易抓取到Https请求的明文数据？
    - 其实Charles上显示确实抓到了包，但是当看抓包的详细数据时会发现报错 You may need to configure your browser or application to trust the Charles Root Certificate. See SSL Proxying in the Help menu。
    - Charles说手机端没有信任Charles的根证书，但是我们手机上已经安装了Charles根证书了，为什么会这样？
    - 原来在Android 7.0(API 24 ) ，有一个名为“Network Security Configuration”的新安全功能。这个新功能的目标是允许开发人员在不修改应用程序代码的情况下自定义他们的网络安全设置。
    - 如果应用程序运行的系统版本高于或等于24，并且targetSdkVersion>=24，则只有系统(system)证书才会被信任。用户(user)导入的Charles根证书是不被信任的。
- Android 7.0 (api 24 ) 和 targetSdkVersion 对抓包的影响
    - 1.抓自己开发的app的网络包；2.抓第三方app的网络包，比如微博客户端
    - 这两种情况有什么区别的，第一种app是我们自己开发的，我们手里有源码，能够修改，能够做到像官方文档里面说的一样进行配置。第二种我们没有源码，要想做到像官方文档里面配置的话，只能反编译后，把配置文件添加进去然后重新打包，但是重新打包就会遇到很多坑，并不一定能成功，所以需要使用其他方式达到抓包目的。
    - 引用官方文档一句话：默认情况下，来自所有应用的安全连接（使用 TLS 和 HTTPS 之类的协议）均信任预装的系统 CA，而面向 Android 6.0（API 级别 23）及更低版本的应用默认情况下还会信任用户添加的 CA 存储。应用可以使用 base-config（应用范围的自定义）或 domain-config（按域自定义）自定义自己的连接。



#### 1.3 设计目标


#### 1.4 收益分析



### 02.抓包的原理分析
#### 2.0 Https三要素
- 要清楚HTTPS抓包的原理，首先需要先说清楚 HTTPS 实现数据安全传输的工作原理，主要分为三要素和三阶段。
- 三要素分别是：
    - 1.加密：通过对称加密算法实现。
    - 2.认证：通过数字签名实现。（因为私钥只有 “合法的发送方” 持有，其他人伪造的数字签名无法通过验证）
    - 3.报文完整性：通过数字签名实现。（因为数字签名中使用了消息摘要，其他人篡改的消息无法通过验证）
- 三阶段分别是：
    - 1.CA 证书校验：CA 证书校验发生在 TLS 的前两次握手，客户端和服务端通过报文获得服务端 CA 证书，客户端验证 CA 证书合法性，从而确认 CA 证书中的公钥合法性（大多数场景不会做双向认证，即服务端不会认证客户端合法性，这里先不考虑）。
    - 2.密钥协商：密钥协商发生在 TLS 的后两次握手，客户端和服务端分别基于公钥和私钥进行非对称加密通信，协商获得 Master Secret 对称加密私钥（不同算法的协商过程细节略有不同）。
    - 3.数据传输：数据传输发生在 TLS 握手之后，客户端和服务端基于协商的对称密钥进行对称加密通信。



#### 2.1 抓包核心原理
- HTTPS抓包原理
    - Fiddler、Charles等抓包工具，其实都是采用了中间人攻击的方案： 将客户端的网络流量代理到MITM(中间人)主机，再通过一系列的面板或工具将网络请求结构化地呈现出来。
- 抓包Https有两个突破点
    - CA证书校验是否合法；数据传递过程中的加密和解密。如果是要抓包，则需要突破这两点的技术，无非就是MITM(中间人)伪造证书和使用自己的加解密方式。


#### 2.2 如何搞定CA证书
- Https抓包核心CA证书
    - HTTPS抓包的原理还是挺简单的，简单来说，就是Charles作为“中间人代理”，拿到了服务器证书公钥和HTTPS连接的对称密钥。
    - 前提是客户端选择信任并安装Charles的CA证书，否则客户端就会“报警”并中止连接。这样看来，HTTPS还是很安全的。
- CA证书伪造操作说明



#### 2.3 如何搞定加解密


#### 2.4 抓包原理图
- Charles抓包原理图
    - ![image](https://img-blog.csdnimg.cn/20200921192339473.png)



#### 2.4 抓包核心流程
- 抓包核心流程关键节点
    - 第一步，客户端向服务器发起HTTPS请求，charles截获客户端发送给服务器的HTTPS请求，charles伪装成客户端向服务器发送请求进行握手 。
    - 第二步，服务器发回相应，charles获取到服务器的CA证书，用根证书（这里的根证书是CA认证中心给自己颁发的证书）公钥进行解密，验证服务器数据签名，获取到服务器CA证书公钥。然后charles伪造自己的CA证书（这里的CA证书，也是根证书，只不过是charles伪造的根证书），冒充服务器证书传递给客户端浏览器。
    - 第三步，与普通过程中客户端的操作相同，客户端根据返回的数据进行证书校验、生成密码Pre_master、用charles伪造的证书公钥加密，并生成HTTPS通信用的对称密钥enc_key。
    - 第四步，客户端将重要信息传递给服务器，又被charles截获。charles将截获的密文用自己伪造证书的私钥解开，获得并计算得到HTTPS通信用的对称密钥enc_key。charles将对称密钥用服务器证书公钥加密传递给服务器。
    - 第五步，与普通过程中服务器端的操作相同，服务器用私钥解开后建立信任，然后再发送加密的握手消息给客户端。
    - 第六步，charles截获服务器发送的密文，用对称密钥解开，再用自己伪造证书的私钥加密传给客户端。
    - 第七步，客户端拿到加密信息后，用公钥解开，验证HASH。握手过程正式完成，客户端与服务器端就这样建立了”信任“。
- 在之后的正常加密通信过程中，charles如何在服务器与客户端之间充当第三者呢？
    - 服务器—>客户端：charles接收到服务器发送的密文，用对称密钥解开，获得服务器发送的明文。再次加密， 发送给客户端。
    - 客户端—>服务端：客户端用对称密钥加密，被charles截获后，解密获得明文。再次加密，发送给服务器端。由于charles一直拥有通信用对称密钥enc_key，所以在整个HTTPS通信过程中信息对其透明。



### 03.防止抓包思路
#### 3.1 先看如何抓包
- 使用Charles需要做哪些操作
    - **1.电脑上需要安装证书**。这个主要是让Charles充当中间人，颁布自己的CA证书。
    - **2.手机上需要安装证书**。这个是访问Charles获取手机证书，然后安装即可。
    - **3.Android项目代码设置兼容**。Google 推出更加严格的安全机制，应用默认不信任用户证书（手机里自己安装证书），自己的app可以通过配置解决，相当于信任证书的一种操作！


#### 3.2 设置配置文件


#### 3.3 关闭代理



#### 3.4 数据加密处理
- 如何做数据加密
    - RC4加密和解密数据
- 抓取到的内容为乱码
    - 有的APP为了防止抓取，在返回的内容上做了层加密，所以从Charles上看到的内容是乱码。这种情况下也只能反编译APP，研究其加密解密算法进行解密。难度极大！


#### 3.5 黑科技抓包
- 黑科技如何抓包
    - 虽然7.0之后常规手段不能抓https的包，但是可以通过黑科技跳过证书验证流程。例如，通过xposed，安装JustTrustMe模块，可以操作https证书检测直接跳过。




### 04.防抓包实践开发
#### 4.1 App安全配置
- 添加配置文件
    - android:networkSecurityConfig="@xml/network_security_config"
- 在官方文档找到了答案：
    - 网络安全性配置特性让应用可以在一个安全的声明性配置文件中自定义其网络安全设置，而无需修改应用代码。可以针对特定域和特定应用配置这些设置。此特性的主要功能如下所示：
    - 自定义信任锚：针对应用的安全连接自定义哪些证书颁发机构 (CA) 值得信任。例如，信任特定的自签署证书或限制应用信任的公共 CA 集。
    - 仅调试重写：在应用中以安全方式调试安全连接，而不会增加已安装用户的风险。
    - 明文通信选择退出：防止应用意外使用明文通信。
    - 证书固定：将应用的安全连接限制为特定的证书。



#### 4.2 关闭代理
- charles 和 fiddler 都使用代理来进行抓包，对网络客户端使用无代理模式即可防止抓包，如
    ``` java
    OkHttpClient.Builder()
        .proxy(Proxy.NO_PROXY)
        .build()
    ```
- no_proxy实际上就是type属性为direct的一个proxy对象，这个type有三种
    - direct，http，socks。这样因为是直连，所以不走代理。所以charles等工具就抓不到包了，这样一定程度上保证了数据的安全，这种方式只是通过代理抓不到包。
- 通常情况下上述的办法有用，但是无法防住使用 VPN 导流进行的抓包
    - 使用VPN抓包的原理是，先将手机请求导到VPN，再对VPN的网络进行Charles的代理，绕过了对App的代理。



#### 4.3 证书校验




#### 4.3 OkHttp配置




#### 4.4 防止挂载抓包







