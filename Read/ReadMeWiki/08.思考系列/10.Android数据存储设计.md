# Android数据存储设计
#### 目录介绍
- 01.有哪些存储的框架
- 02.传递数据的序列化
- 04.Sp前世今生分析
- 05.DataStore原理
- 06.MMKV的存储分析
- 07.
- 08.去黑科技mmap理解





### 04.Sp前世今生分析
#### 4.1 Sp的主要缺点
- Sp主要缺点
    - SP用内存层用HashMap保存，磁盘层则是用的XML文件保存。每次更改，都需要将整个HashMap序列化为XML格式的报文然后整个写入文件。
- 归结其较慢的原因：
    - 1、不能增量写入；2、序列化比较耗时。


### 05.DataStore原理



### 06.MMKV的存储分析
#### 6.1 MMKV的不足
- 没有类型信息，不支持getAll：
    - MMKV的存储用类似于Protobuf的编码方式，只存储key和value本身，没有存类型信息（Protobuf用tag标记字段，信息更少）。由于没有记录类型信息，MMKV无法自动反序列化，也就无法实现getAll接口。
- 读取相对较慢：
    - SP在加载的时候已经将value反序列化存在HashMap中了，读取的时候索引到之后就能直接引用了。而MMKV每次读取时都需要重新解码，除了时间上的消耗之外，还需要每次都创建新的对象。
- 需要引入so, 增加包体积：
    - 引入MMKV需要增加的体积还是不少的，且不说jar包和aidl文件，光是一个arm64-v8a的so就有四百多K。
- 文件只增不减：
    - MMKV的扩容策略还是比较激进的，而且扩容之后不会主动trim size。
- 可能会丢失数据：
    - 通过 mmap 内存映射文件，提供一段可供随时写入的内存块，App 只管往里面写数据，由操作系统负责将内存回写到文件，不必担心 crash 导致数据丢失。
    - 如果数据完成写入到内存块，如果系统不崩溃，即使进程崩溃，系统也会将buffer刷入磁盘。
    - 但是如果在刷入磁盘之前发生系统崩溃或者断电等，数据就丢失了，不过这种情况发生的概率不大。
    - 另一种情况是数据写一半的时候进程崩溃或者被杀死，然后系统会将已写入的部分刷入磁盘，再次打开时文件可能就不完整了。


#### 6.2 MMKV的背景




### 08.去黑科技mmap理解
#### 8.1 mmap理解介绍
- 操作系统分为内核态和用户态两种运行模式：
    - 内核态(Kernel MODE)能够运行操作系统程序 
    - 用户态(User MODE)能够运行用户程序。用户态(即应用程序)是不能直接对物理设备进行操作的(Ps:对物理设备进行操作，即对设备的物理地址写数据)。
- 为什么有内存映射这个概念
    - 如果想读取硬盘上的某一段数据通常都需要经过 硬盘->内核->用户，即数据需要经历两次拷贝，效率十分低下。
    - 内核映射即mmap，mmap将设备的物理地址映射到进程的虚拟地址，则用户操作虚拟内存时就相当于对物理设备进行操作了，减少了内核到用户的一次数据拷贝，从而提高数据的吞吐率。
    - 当使用mmap映射文件到进程后，就可以直接操作这段虚拟地址进行文件的读写等操作，不必再调用read，write等系统调用。
- mmap区别于以往的文件读写，具备以下几个优点：
    - 减少了数据的拷贝次数，用内存读写取代I/O读写，提高了文件读取效率；实现了用户空间和内核空间的高效交互方式。
    - 提供进程间共享内存及相互通信的方式；可用于实现高效的大规模数据传输。


#### 8.2 mmap使用分类
- 按照归类的思想，其实mmap主要用到的分为两类（还有其他标识不讨论）：
    - 1.共享的：即对该线性区中的页（注意是以页为单位）的任何写操作，都会修改磁盘上的文件，并且如果一个进程对进行了mmap的页进行了写操作，那么对于其他进程（同样也通过mmap进行了映射），同样也是可见的。
    - 2.私有的：对于私有映射页的任何写操作，都会使linux内核停止映射该文件的页（注意，假如有进程a，b同时映射了该页，a对页进行了修改，此时这个页就相当于复制出来了一份，a以后的操作就在复制的该页进行操作，b还是引用原来的页，原来的页就可以继续参与内存映射，而复制出来的页，就被停止映射了），因此，在私有情况下，写操作是不会改变磁盘上的文件，同时所做的修改对于其他进程来说，就是不可见的。


#### 8.3 数据写回磁盘
- 当进程被意外杀死了后是如何写入数据的。真正写入其实是靠系统调用写入，即msync函数。
    ``` cmake
    int msync(void* __addr, size_t __size, int __flags);
    ```
    - mmap的数据写入依靠着这个系统调用保证，即当前进程被异常销毁了，也可以通过这个系统级别的调用，把属于内存映射的脏页数据写回去磁盘。
- mmap系统写入数据一定靠谱嘛
    - 虽然这个刷新动作是由linux系统进行刷入的，保证了进程出问题的时候，也能够在系统级别刷入数据，但是这个也不是百分百可靠的，因为这个刷入操作是没有备份操作的/异常容灾处理，如果系统异常或者断电的情况，就会出现错误数据或者没有完全刷入磁盘的数据，造成数据异常。



#### 参考博客
- 聊一聊MMKV背后黑科技mmap的秘密！
    - https://mp.weixin.qq.com/s/zqRmi5QmjM5WbYJ7oi3iRQ
- Android 的键值对存储有没有最优解？
    - https://blog.csdn.net/LSpQ35k7O5AJ21l1H9o/article/details/125437208




